<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>图片处理测试</title>
    <style>
        body {
            margin: 0;
        }

        #app {
            display: flex;
            flex-direction: column;
            padding: 0 1rem;
            box-sizing: border-box;
        }

        #app > * {
            padding: 1rem 0 0;
            box-sizing: border-box;
        }

        #controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #controls > div {
            display: flex;
            align-items: center;
        }

        #controls > div:not(:last-child) {
            margin-right: 12px;
        }

         #controls > div:nth-child(2){
             flex-grow: 1;
         }

        #controls > div > *:not(:last-child) {
            margin-right: 12px;
        }

        #splitter {
            width: 100%;
            height: 0;
            border-bottom: 1px dashed #999;
        }

        #render > img {
            max-width: 100%;
        }

        input[type="number"] {
            max-width: 88px;
        }
    </style>
</head>
<body>
<div id="app">
    <div id="controls">
        <div>
            <label for="threshold">threshold</label>
            <input type="range" min="0" max="255" v-model="inputValue">
            <input id="threshold" type="number" title="0-255，浅色图像可以调高点，反之同理" min="0" max="255" v-model="inputValue">
        </div>
        <div>
            <label for="renderDelay">重绘延迟</label>
            <input id="renderDelay" type="number" min="0" v-model="renderDelay" title="render delay" placeholder="重绘延迟">
            <progress v-if="processing"></progress>
        </div>
        <div>
            <button @click="syncControls">点击渲染</button>
        </div>
    </div>
    <div id="splitter"></div>
    <div id="render">
        <img v-if="renderImgPath" :src="renderImgPath" :alt="renderImgPath">
        <span v-else>暂无内容</span>
    </div>
</div>
<script src="./vue.min.js"></script>
<script type="module">
    const {ref, watch} = Vue
    Vue.createApp({
        setup() {
            const inputValue = ref(100)
            const renderDelay = ref(100)

            watch(() => inputValue.value, v => {
                console.log(typeof v)
                if (v > 255) inputValue.value = 255
                else if (v < 0) inputValue.value = 0
                syncControls()
            })

            watch(() => renderDelay.value, v => {
                if(typeof renderDelay.value === "string") renderDelay.value = parseInt(v)
            })

            const renderImgPath = ref("")
            const processing = ref(false)

            // 渲染延迟ms
            const tid = ref(0)
            const syncControls = () => {
                tid.value && clearTimeout(tid.value)
                tid.value = setTimeout(() => {
                    processing.value = true
                    window.pywebview.api.syncControls(inputValue.value).then(imgPath => {
                        if (imgPath) renderImgPath.value = imgPath
                        processing.value = false
                    })
                }, renderDelay.value)
            }
            return {
                inputValue,
                renderImgPath,
                renderDelay,
                processing,
                syncControls
            }
        },
        methods: {
        }
    }).mount("#app")
</script>
</body>
</html>